<!DOCTYPE html>
<html>
<head>
    <title>Global Chatroom v7.0</title>
</head>
<body>
    <div id="app"></div>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        const supabase = createClient('https://hxgyosaofvxwongalvwr.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4Z3lvc2FvZnZ4d29uZ2FsdndyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzA4NjYsImV4cCI6MjA3NjkwNjg2Nn0.O20SfjvTGV2O7X2cKt6jhRXe06BbqTLb8I_j7bv0Obo');
        const VERSION='v7.0',GIFS=['https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif','https://media.giphy.com/media/ujUdrdpX7Ok5W/giphy.gif','https://media.giphy.com/media/ZdUnQS4AXEl1AERdil/giphy.gif'],DEFAULT_PIC='https://cdn-icons-png.flaticon.com/512/3177/3177440.png';
        let username='',isGuest=false,joined=false,notificationsEnabled=false,lastMessageCount=0,replyingTo=null,onlineUsers=0,showChangelog=false,showMediaPicker=false,isRecording=false,mediaRecorder=null,audioChunks=[],cameraStream=null,showCamera=false,authMode='login',currentGroupId=null,groups=[],showMessageMenu=null,unreadCounts={},showProfileEditor=false,showProfileCard=null,userProfile={profile_picture:null,bio:'No bio yet',profile_banner:null,custom_role:null,badges:[]},userProfiles={},leaderboard=[],lastMonthWinner=null,showRewards=false,showLeaderboard=false,userPoints=0,currentMonth=new Date().toLocaleString('default',{month:'long',year:'numeric'});
        
        async function getCurrentMonth(){return new Date().toLocaleString('default',{month:'long',year:'numeric'})}
        
        async function loadLeaderboard(){if(isGuest)return;try{const month=await getCurrentMonth();const{data}=await supabase.from('leaderboard').select('*').eq('month',month).order('points',{ascending:false}).limit(10);if(data){leaderboard=data;const userEntry=data.find(e=>e.username===username);userPoints=userEntry?userEntry.points:0}}catch(e){}}
        
        async function loadLastMonthWinner(){try{const{data}=await supabase.from('monthly_winners').select('*').order('won_at',{ascending:false}).limit(1).single();if(data)lastMonthWinner=data}catch(e){}}
        
        async function addPointsForMessage(){if(isGuest||currentGroupId)return;const month=await getCurrentMonth();try{const{data:userData}=await supabase.from('leaderboard').select('*').eq('username',username).eq('month',month).single();const now=new Date();if(userData){const lastMessageTime=new Date(userData.last_message_time);const timeDiff=now-lastMessageTime;if(timeDiff<1000){const newSpamCount=(userData.spam_count||0)+1;if(newSpamCount>=3){alert('âš ï¸ SPAM DETECTED! Slow down.');await supabase.from('leaderboard').update({spam_count:0,last_message_time:now.toISOString()}).eq('username',username).eq('month',month);return false}else{await supabase.from('leaderboard').update({spam_count:newSpamCount,last_message_time:now.toISOString()}).eq('username',username).eq('month',month)}}else{await supabase.from('leaderboard').update({points:userData.points+1,spam_count:0,last_message_time:now.toISOString()}).eq('username',username).eq('month',month)}}else{await supabase.from('leaderboard').insert([{username:username,points:1,month:month,last_message_time:now.toISOString(),spam_count:0}])}await loadLeaderboard();return true}catch(e){return false}}
        
        async function loadUserProfile(){if(isGuest)return;try{const{data}=await supabase.from('users').select('profile_picture,bio,profile_banner,custom_role,role_expires').eq('username',username).single();if(data){let customRole=data.custom_role;if(data.role_expires&&new Date(data.role_expires)<new Date()){customRole=null;await supabase.from('users').update({custom_role:null,role_expires:null}).eq('username',username)}userProfile={profile_picture:data.profile_picture||null,bio:data.bio||'No bio yet',profile_banner:data.profile_banner||null,custom_role:customRole,badges:[]}}const{data:badgesData}=await supabase.from('user_badges').select('*').eq('username',username);if(badgesData)userProfile.badges=badgesData}catch(e){}}
        
        async function loadOtherUserProfile(user){if(userProfiles[user])return userProfiles[user];const cleanUsername=user.replace(' (GUEST)','');try{const{data}=await supabase.from('users').select('profile_picture,bio,profile_banner,custom_role,role_expires').eq('username',cleanUsername).single();if(data){let customRole=data.custom_role;if(data.role_expires&&new Date(data.role_expires)<new Date())customRole=null;const{data:badgesData}=await supabase.from('user_badges').select('*').eq('username',cleanUsername);userProfiles[user]={profile_picture:data.profile_picture||null,bio:data.bio||'No bio yet',profile_banner:data.profile_banner||null,custom_role:customRole,badges:badgesData||[]};return userProfiles[user]}}catch(e){}return{profile_picture:null,bio:'No bio yet',profile_banner:null,custom_role:null,badges:[]}}
        
        async function updateProfile(profilePic,bio,banner){try{await supabase.from('users').update({profile_picture:profilePic,bio:bio,profile_banner:banner}).eq('username',username);userProfile.profile_picture=profilePic;userProfile.bio=bio;userProfile.profile_banner=banner;userProfiles[username]=userProfile;showProfileEditor=false;render()}catch(e){alert('Error:'+e.message)}}
        
        async function loadGroups(){if(isGuest)return;try{const{data}=await supabase.from('groups').select('*').contains('members',[username]);if(data)groups=data.filter(g=>g.is_dm);const{data:unreadData}=await supabase.from('unread_messages').select('*').eq('username',username);if(unreadData){unreadCounts={};unreadData.forEach(item=>unreadCounts[item.group_id]=item.count)}}catch(e){}}
        
        async function createDM(targetUser){if(isGuest)return;const existingDM=groups.find(g=>g.is_dm&&g.members.includes(username)&&g.members.includes(targetUser));if(existingDM){currentGroupId=existingDM.id;render();loadMessages();return}try{const{data}=await supabase.from('groups').insert([{name:`DM with ${targetUser}`,members:[username,targetUser],is_dm:true,created_by:username}]).select().single();if(data){currentGroupId=data.id;await loadGroups();render();loadMessages()}}catch(e){}}
        
        function render(){const appDiv=document.getElementById('app');if(!joined){appDiv.innerHTML=`<div style="padding:20px"><div style="background:black;color:white;padding:10px;margin:-20px -20px 20px;text-align:center"><strong>Global Chatroom ${VERSION}</strong></div>${lastMonthWinner?`<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;margin-bottom:20px;border-radius:10px;text-align:center"><h3>ğŸ† ${lastMonthWinner.month} Winner</h3><img src="${lastMonthWinner.profile_picture||DEFAULT_PIC}" style="width:60px;height:60px;border-radius:50%;border:3px solid white;margin:10px 0"><h2>${lastMonthWinner.username}</h2><p>${lastMonthWinner.points} points</p></div>`:''}<div style="background:gold;padding:15px;margin-bottom:20px;border:2px solid black;cursor:pointer" id="showRewardsBtn"><h3>ğŸ¯ ${currentMonth} Challenge</h3><p>Click for rewards!</p></div><h1>Global Chatroom</h1><div style="margin-bottom:20px"><button id="loginTabBtn" style="padding:10px 20px;background:${authMode==='login'?'black':'white'};color:${authMode==='login'?'white':'black'}">Login</button><button id="signupTabBtn" style="padding:10px 20px;background:${authMode==='signup'?'black':'white'};color:${authMode==='signup'?'white':'black'}">Sign Up</button><button id="guestTabBtn" style="padding:10px 20px;background:${authMode==='guest'?'black':'white'};color:${authMode==='guest'?'white':'black'}">Guest</button></div>${authMode==='login'?'<h2>Login</h2><input type="text" id="loginUsername" placeholder="Username" style="padding:5px;display:block;margin:10px 0"><input type="password" id="loginPassword" placeholder="Password" style="padding:5px;display:block;margin:10px 0"><button id="loginBtn" style="padding:10px 20px">Login</button><div id="loginError" style="color:red"></div>':''}${authMode==='signup'?'<h2>Sign Up</h2><input type="text" id="signupUsername" placeholder="Username" style="padding:5px;display:block;margin:10px 0"><input type="password" id="signupPassword" placeholder="Password" style="padding:5px;display:block;margin:10px 0"><button id="signupBtn" style="padding:10px 20px">Sign Up</button><div id="signupError" style="color:red"></div>':''}${authMode==='guest'?'<h2>Guest Mode</h2><p style="color:red">âš ï¸ No leaderboard points, DMs, or profiles</p><input type="text" id="guestUsername" placeholder="Username" style="padding:5px;display:block;margin:10px 0"><button id="guestBtn" style="padding:10px 20px">Join</button>':''}</div>${showRewards?`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000" id="rewardsModal"><div style="background:white;margin:50px auto;padding:30px;max-width:600px;border:2px solid black"><h2>ğŸ† Rewards</h2><div style="border:2px solid gold;padding:15px;margin:20px 0;background:lightyellow"><h3>ğŸ–ï¸ Forever Badges</h3><ul><li>"Not a Loser"</li><li>"${currentMonth} Winner"</li></ul></div><div style="border:2px solid silver;padding:15px;margin:20px 0"><h3>â° One Month</h3><ul><li>ğŸ‘‘ Custom Role: "Champion"</li><li>â­ Featured on homepage</li><li>ğŸ¨ Profile Banner</li></ul></div><button id="closeRewards" style="padding:10px 20px;width:100%">Close</button></div></div>`:''}`;document.getElementById('loginTabBtn').onclick=()=>{authMode='login';render()};document.getElementById('signupTabBtn').onclick=()=>{authMode='signup';render()};document.getElementById('guestTabBtn').onclick=()=>{authMode='guest';render()};const showRewardsBtn=document.getElementById('showRewardsBtn');if(showRewardsBtn)showRewardsBtn.onclick=()=>{showRewards=true;render()};const closeRewards=document.getElementById('closeRewards');if(closeRewards)closeRewards.onclick=()=>{showRewards=false;render()};const loginBtn=document.getElementById('loginBtn');if(loginBtn)loginBtn.onclick=async()=>{const user=document.getElementById('loginUsername').value.trim();const pass=document.getElementById('loginPassword').value.trim();const errorDiv=document.getElementById('loginError');if(!user||!pass){errorDiv.textContent='Enter username and password';return}try{const{data}=await supabase.from('users').select('*').eq('username',user).single();if(!data||data.password!==pass){errorDiv.textContent='Invalid credentials';return}username=user;joined=true;await loadUserProfile();await loadGroups();await loadLeaderboard();render();loadMessages();setInterval(loadMessages,2000);setInterval(loadLeaderboard,10000)}catch(e){errorDiv.textContent='Error:'+e.message}};const signupBtn=document.getElementById('signupBtn');if(signupBtn)signupBtn.onclick=async()=>{const user=document.getElementById('signupUsername').value.trim();const pass=document.getElementById('signupPassword').value.trim();const errorDiv=document.getElementById('signupError');if(!user||!pass||user.length<3||pass.length<4){errorDiv.textContent='Username 3+ chars, password 4+ chars';return}try{const{data:existing}=await supabase.from('users').select('username').eq('username',user).single();if(existing){errorDiv.textContent='Username taken';return}await supabase.from('users').insert([{username:user,password:pass}]);username=user;joined=true;await loadUserProfile();await loadGroups();await loadLeaderboard();render();loadMessages();setInterval(loadMessages,2000);setInterval(loadLeaderboard,10000)}catch(e){errorDiv.textContent='Error:'+e.message}};const guestBtn=document.getElementById('guestBtn');if(guestBtn)guestBtn.onclick=()=>{const user=document.getElementById('guestUsername').value.trim();if(!user){alert('Enter username');return}username=user;isGuest=true;joined=true;render();loadMessages();setInterval(loadMessages,2000)}}else{const displayName=isGuest?`${username} (GUEST)`:username;appDiv.innerHTML=`${!isGuest?`<div style="width:250px;background:lightgray;padding:10px;border-right:2px solid black;height:100vh;overflow-y:auto;position:fixed;left:0;top:0;display:flex;flex-direction:column"><div style="flex:1"><h3>Chats</h3><div style="padding:10px;background:${!currentGroupId?'white':'transparent'};border:1px solid black;margin-bottom:5px;cursor:pointer" id="mainChatBtn"><strong>ğŸŒ Everyone</strong></div><h4>DMs</h4>${groups.filter(g=>g.is_dm).map(g=>`<div style="padding:8px;background:${currentGroupId===g.id?'white':'transparent'};border:1px solid black;margin-bottom:3px;cursor:pointer" class="group-btn" data-group-id="${g.id}">ğŸ’¬ ${g.members.find(m=>m!==username)}</div>`).join('')||'<p style="font-size:12px">No DMs</p>'}<h4>ğŸ† Leaderboard</h4><div style="padding:8px;border:1px solid black;margin-bottom:3px;cursor:pointer;background:gold" id="viewLeaderboardBtn"><strong>View Rankings</strong></div><p style="font-size:11px">Your Points: <strong>${userPoints}</strong></p></div><div style="border-top:2px solid black;padding-top:10px"><div style="display:flex;align-items:center;cursor:pointer" id="userProfileBtn"><img src="${userProfile.profile_picture||DEFAULT_PIC}" style="width:40px;height:40px;border-radius:50%;border:2px solid black;margin-right:10px"><div><strong>${username}</strong>${userProfile.custom_role?`<br><span style="font-size:10px;background:gold;padding:2px 4px">ğŸ‘‘ ${userProfile.custom_role}</span>`:'<br><span style="font-size:12px">View Profile</span>'}</div></div></div></div>`:''}
<div style="margin-left:${isGuest?'0':'250px'};padding:20px"><div style="background:black;color:white;padding:10px;margin:-20px -20px 20px;text-align:center"><strong>Chatroom ${VERSION}</strong></div><h1>${currentGroupId?'DM':'Everyone'}</h1><p>Logged in: <strong>${displayName}</strong></p><div id="messages" style="border:1px solid black;height:400px;overflow-y:scroll;padding:10px;margin-bottom:10px"></div><div style="display:flex;gap:5px"><input type="text" id="messageInput" placeholder="Type message..." style="padding:5px;flex:1"><button id="sendBtn" style="padding:5px 15px">Send</button></div></div>${showLeaderboard?`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000" id="leaderboardModal"><div style="background:white;margin:50px auto;padding:20px;max-width:600px;border:2px solid black"><h2>ğŸ† ${currentMonth} Leaderboard</h2><p>Your Points: <strong>${userPoints}</strong></p><table style="width:100%;border-collapse:collapse;margin-top:20px"><thead><tr style="background:black;color:white"><th style="padding:10px">Rank</th><th style="padding:10px">Username</th><th style="padding:10px">Points</th></tr></thead><tbody>${leaderboard.map((e,i)=>`<tr style="border-bottom:1px solid gray;background:${e.username===username?'lightyellow':'white'}"><td style="padding:10px">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`}</td><td style="padding:10px"><strong>${e.username}</strong></td><td style="padding:10px">${e.points}</td></tr>`).join('')}</tbody></table><button id="closeLeaderboard" style="padding:10px 20px;width:100%;margin-top:20px">Close</button></div></div>`:''}${showProfileEditor?`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000" id="profileEditorModal"><div style="background:white;margin:50px auto;padding:20px;max-width:400px;border:2px solid black"><h2>Edit Profile</h2>${userProfile.profile_banner?`<div style="width:100%;height:100px;background:url('${userProfile.profile_banner}') center/cover;border:2px solid black;margin-bottom:10px"></div>`:''}<div style="text-align:center;margin-bottom:20px"><img src="${userProfile.profile_picture||DEFAULT_PIC}" style="width:100px;height:100px;border-radius:50%;border:2px solid black"></div><div style="margin-bottom:15px"><label><strong>Profile Picture:</strong></label><br><input type="file" id="profilePicUpload" accept="image/*" style="padding:5px;margin-top:5px"></div>${userProfile.custom_role==='Leaderboard Champion'?'<div style="margin-bottom:15px"><label><strong>Banner (Winner Reward):</strong></label><br><input type="file" id="profileBannerUpload" accept="image/*" style="padding:5px;margin-top:5px"></div>':''}<div style="margin-bottom:15px"><label><strong>Bio:</strong></label><br><textarea id="bioInput" style="width:100%;padding:5px;height:80px;margin-top:5px">${userProfile.bio}</textarea></div>${userProfile.badges.length>0?`<div><strong>Badges:</strong><br>${userProfile.badges.map(b=>`<span style="background:gold;padding:3px 8px;margin:3px;display:inline-block;font-size:12px;border-radius:3px">ğŸ† ${b.badge}</span>`).join('')}</div>`:''}<button id="saveProfileBtn" style="padding:10px 20px;margin-right:10px">Save</button><button id="closeProfileEditor" style="padding:10px 20px">Cancel</button></div></div>`:''}${showProfileCard?`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000" id="profileCardModal"><div style="background:white;margin:100px auto;padding:0;max-width:350px;border:2px solid black;overflow:hidden">${showProfileCard.profile_banner?`<div style="width:100%;height:120px;background:url('${showProfileCard.profile_banner}') center/cover"></div>`:'<div style="width:100%;height:120px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)"></div>'}<div style="padding:20px;text-align:center"><img src="${showProfileCard.profile_picture||DEFAULT_PIC}" style="width:80px;height:80px;border-radius:50%;border:3px solid white;margin-top:-50px;background:white"><h2>${showProfileCard.username}</h2>${showProfileCard.custom_role?`<div style="background:gold;padding:5px;margin:5px auto;width:fit-content;font-size:14px"><strong>ğŸ‘‘ ${showProfileCard.custom_role}</strong></div>`:''}<p style="color:gray;font-style:italic">"${showProfileCard.bio}"</p>${showProfileCard.badges&&showProfileCard.badges.length>0?`<div style="margin-top:15px;text-align:left"><strong>Badges:</strong><br>${showProfileCard.badges.map(b=>`<span style="background:gold;padding:3px 8px;margin:3px;display:inline-block;font-size:11px;border-radius:3px">ğŸ† ${b.badge}</span>`).join('')}</div>`:''}<button id="closeProfileCard" style="padding:8px 16px;margin-top:15px">Close</button></div></div></div>`:''}`;
const mainChatBtn=document.getElementById('mainChatBtn');if(mainChatBtn)mainChatBtn.onclick=()=>{currentGroupId=null;render();loadMessages()};document.querySelectorAll('.group-btn').forEach(btn=>btn.onclick=()=>{currentGroupId=btn.dataset.groupId;render();loadMessages()});const viewLeaderboardBtn=document.getElementById('viewLeaderboardBtn');if(viewLeaderboardBtn)viewLeaderboardBtn.onclick=()=>{showLeaderboard=true;render()};const closeLeaderboard=document.getElementById('closeLeaderboard');if(closeLeaderboard)closeLeaderboard.onclick=()=>{showLeaderboard=false;render()};const userProfileBtn=document.getElementById('userProfileBtn');if(userProfileBtn)userProfileBtn.onclick=()=>{showProfileEditor=true;render()};const saveProfileBtn=document.getElementById('saveProfileBtn');if(saveProfileBtn)saveProfileBtn.onclick=async()=>{const bioInput=document.getElementById('bioInput');const profilePicInput=document.getElementById('profilePicUpload');const bannerInput=document.getElementById('profileBannerUpload');let newProfilePic=userProfile.profile_picture;let newBanner=userProfile.profile_banner;if(profilePicInput&&profilePicInput.files[0]){const file=profilePicInput.files[0];const fileName=`${username}_${Date.now()}.jpg`;const{data}=await supabase.storage.from('profile-pictures').upload(fileName,file);const{data:publicURL}=supabase.storage.from('profile-pictures').getPublicUrl(fileName);newProfilePic=publicURL.publicUrl}if(bannerInput&&bannerInput.files[0]){const file=bannerInput.files[0];const fileName=`${username}_banner_${Date.now()}.jpg`;const{data}=await supabase.storage.from('profile-banners').upload(fileName,file);const{data:publicURL}=supabase.storage.from('profile-banners').getPublicUrl(fileName);newBanner=publicURL.publicUrl}await updateProfile(newProfilePic,bioInput.value.trim(),newBanner)};const closeProfileEditor=document.getElementById('closeProfileEditor');if(closeProfileEditor)closeProfileEditor.onclick=()=>{showProfileEditor=false;render()};const closeProfileCard=document.getElementById('closeProfileCard');if(closeProfileCard)closeProfileCard.onclick=()=>{showProfileCard=null;render()};document.getElementById('sendBtn').onclick=sendMessage;document.getElementById('messageInput').onkeypress=e=>{if(e.key==='Enter')sendMessage()}}}
async function loadMessages(){let query=supabase.from('messages').select('*').order('created_at',{ascending:true}).limit(50);if(currentGroupId)query=query.eq('group_id',currentGroupId);else query=query.is('group_id',null);const{data}=await query;if(data){const messagesDiv=document.getElementById('messages');if(messagesDiv){messagesDiv.innerHTML='';for(const msg of data){const msgDiv=document.createElement('div');msgDiv.style.marginBottom='10px';msgDiv.style.padding='5px';msgDiv.style.display='flex';msgDiv.style.gap='10px';const userProfileData=await loadOtherUserProfile(msg.username);let html='';if(!msg.username.includes('(GUEST)'))html+=`<div style="flex-shrink:0"><img src="${userProfileData.profile_picture||DEFAULT_PIC}" class="user-profile-pic" data-username="${msg.username}" style="width:40px;height:40px;border-radius:50%;border:2px solid black;cursor:pointer"></div>`;html+='<div style="flex:1">';html+=`<strong>${msg.username}</strong>`;if(userProfileData.custom_role)html+=` <span style="background:gold;padding:2px 5px;font-size:10px;border-radius:3px">ğŸ‘‘ ${userProfileData.custom_role}</span>`;html+='<br>';if(msg.image_url)html+=`<img src="${msg.image_url}" style="max-width:300px;margin-top:5px;border:1px solid black">`;if(msg.voice_url)html+=`<div style="margin-top:5px"><audio controls preload="metadata"><source src="${msg.voice_url}" type="audio/webm"></audio></div>`;if(msg.text)html+=msg.text;if(!isGuest&&!currentGroupId&&!msg.username.includes('(GUEST)'))html+=`<span class="msg-menu-btn" data-username="${msg.username}" style="float:right;cursor:pointer;padding:2px 5px;display:none">â‹®</span>`;html+='</div>';msgDiv.innerHTML=html;msgDiv.onmouseenter=()=>{const menuBtn=msgDiv.querySelector('.msg-menu-btn');if(menuBtn)menuBtn.style.display='inline'};msgDiv.onmouseleave=()=>{const menuBtn=msgDiv.querySelector('.msg-menu-btn');if(menuBtn)menuBtn.style.display='none'};messagesDiv.appendChild(msgDiv)}document.querySelectorAll('.user-profile-pic').forEach(pic=>pic.onclick=async()=>{const targetUsername=pic.dataset.username;const profile=await loadOtherUserProfile(targetUsername);showProfileCard={username:targetUsername,profile_picture:profile.profile_picture,bio:profile.bio,profile_banner:profile.profile_banner,custom_role:profile.custom_role,badges:profile.badges};render()});document.querySelectorAll('.msg-menu-btn').forEach(btn=>btn.onclick=e=>{e.stopPropagation();const targetUser=btn.dataset.username;const menu=document.createElement('div');menu.style.position='absolute';menu.style.background='white';menu.style.border='2px solid black';menu.style.padding='10px';menu.style.zIndex='999';menu.style.left=e.pageX+'px';menu.style.top=e.pageY+'px';menu.innerHTML='<div style="cursor:pointer;padding:5px" id="dm-option">ğŸ’¬ Send DM</div>';document.body.appendChild(menu);document.getElementById('dm-option').onclick=()=>{createDM(targetUser);menu.remove()};setTimeout(()=>document.addEventListener('click',function closeMenu(){menu.remove();document.removeEventListener('click',closeMenu)}),100)});messagesDiv.scrollTop=messagesDiv.scrollHeight}}}
async function sendMessage(){const input=document.getElementById('messageInput');if(input.value.trim()){const displayName=isGuest?`${username} (GUEST)`:username;await addPointsForMessage();await supabase.from('messages').insert([{username:displayName,text:input.value.trim(),group_id:currentGroupId}]);input.value='';render()}}
loadLastMonthWinner();render();
    </script>
</body>
</html>
