<!DOCTYPE html>
<html>
<head>
    <title>Global Chatroom</title>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://hxgyosaofvxwongalvwr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4Z3lvc2FvZnZ4d29uZ2FsdndyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzA4NjYsImV4cCI6MjA3NjkwNjg2Nn0.O20SfjvTGV2O7X2cKt6jhRXe06BbqTLb8I_j7bv0Obo'
        );

        let username = '';
        let joined = false;
        let notificationsEnabled = false;
        let lastMessageCount = 0;

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }

        function showNotification(user, text) {
            if (notificationsEnabled && Notification.permission === 'granted' && document.hidden) {
                new Notification(`${user} says:`, {
                    body: text,
                    icon: 'https://cdn-icons-png.flaticon.com/512/134/134914.png'
                });
            }
        }

        function render() {
            const appDiv = document.getElementById('app');
            
            if (!joined) {
                appDiv.innerHTML = `
                    <div style="padding: 20px; font-family: Arial;">
                        <h1>Global Chatroom</h1>
                        <p>Enter your username to join</p>
                        <input type="text" id="usernameInput" placeholder="Username" style="padding: 5px; margin-right: 10px;">
                        <button id="joinBtn" style="padding: 5px 15px;">Join</button>
                    </div>
                `;
                
                document.getElementById('joinBtn').onclick = async () => {
                    const input = document.getElementById('usernameInput');
                    if (input.value.trim()) {
                        username = input.value.trim();
                        joined = true;
                        await requestNotificationPermission();
                        render();
                        loadMessages();
                        setInterval(loadMessages, 2000);
                    }
                };
                
                document.getElementById('usernameInput').onkeypress = (e) => {
                    if (e.key === 'Enter') document.getElementById('joinBtn').click();
                };
            } else {
                appDiv.innerHTML = `
                    <div style="padding: 20px; font-family: Arial;">
                        <h1>Global Chatroom</h1>
                        <p>Logged in as: ${username}</p>
                        <div style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" id="notifToggle" ${notificationsEnabled ? 'checked' : ''}>
                                Enable Notifications
                            </label>
                        </div>
                        <div id="messages" style="border: 1px solid black; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;"></div>
                        <input type="text" id="messageInput" placeholder="Type message..." style="padding: 5px; width: 300px; margin-right: 10px;">
                        <button id="sendBtn" style="padding: 5px 15px;">Send</button>
                    </div>
                `;
                
                document.getElementById('notifToggle').onchange = async (e) => {
                    notificationsEnabled = e.target.checked;
                    if (notificationsEnabled && Notification.permission === 'default') {
                        await requestNotificationPermission();
                    }
                };
                
                document.getElementById('sendBtn').onclick = sendMessage;
                document.getElementById('messageInput').onkeypress = (e) => {
                    if (e.key === 'Enter') sendMessage();
                };
            }
        }

        async function loadMessages() {
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(50);

            if (data) {
                const messagesDiv = document.getElementById('messages');
                if (messagesDiv) {
                    const wasAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop === messagesDiv.clientHeight;
                    
                    if (data.length > lastMessageCount && lastMessageCount > 0) {
                        const newMessage = data[data.length - 1];
                        if (newMessage.username !== username) {
                            showNotification(newMessage.username, newMessage.text);
                        }
                    }
                    lastMessageCount = data.length;
                    
                    messagesDiv.innerHTML = '';
                    data.forEach(msg => {
                        const msgDiv = document.createElement('div');
                        msgDiv.style.marginBottom = '8px';
                        msgDiv.innerHTML = `<strong>${msg.username}:</strong> ${msg.text}`;
                        messagesDiv.appendChild(msgDiv);
                    });
                    
                    if (wasAtBottom || lastMessageCount === data.length) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim()) {
                await supabase
                    .from('messages')
                    .insert([
                        { username: username, text: input.value.trim() }
                    ]);
                input.value = '';
            }
        }

        render();
    </script>
</body>
</html>
