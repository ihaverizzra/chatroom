<!DOCTYPE html>
<html>
<head>
    <title>Global Chatroom</title>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabase = createClient(
            'https://hxgyosaofvxwongalvwr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4Z3lvc2FvZnZ4d29uZ2FsdndyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMzA4NjYsImV4cCI6MjA3NjkwNjg2Nn0.O20SfjvTGV2O7X2cKt6jhRXe06BbqTLb8I_j7bv0Obo'
        );

        const VERSION = 'v3.2';
        const CHANGELOG = [
            { version: 'v3.2', changes: ['Camera capture', 'Take photos directly'] },
            { version: 'v3.1', changes: ['Voice messages', 'Hold to record audio'] },
            { version: 'v3.0', changes: ['Image uploads', 'GIF picker', 'Media support'] },
            { version: 'v2.0', changes: ['Reply to messages', 'Online user count', 'Message timestamps', 'Version banner'] },
            { version: 'v1.0', changes: ['Initial release', 'Basic chat functionality', 'Notifications'] }
        ];

        // Add your GIF links here - just edit this list!
        const GIFS = [
            'https://media.giphy.com/media/3oriO0OEd9QIDdllqo/giphy.gif',
            'https://media.giphy.com/media/ujUdrdpX7Ok5W/giphy.gif',
            'https://media.giphy.com/media/ZdUnQS4AXEl1AERdil/giphy.gif',
            'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif',
            'https://media.giphy.com/media/XreQmk7ETCak0/giphy.gif'
        ];

        let username = '';
        let joined = false;
        let notificationsEnabled = false;
        let lastMessageCount = 0;
        let replyingTo = null;
        let onlineUsers = 0;
        let showChangelog = false;
        let showMediaPicker = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let cameraStream = null;
        let showCamera = false;

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }

        function showNotification(user, text) {
            if (notificationsEnabled && Notification.permission === 'granted' && document.hidden) {
                new Notification(`${user} says:`, {
                    body: text || 'Sent an image',
                    icon: 'https://cdn-icons-png.flaticon.com/512/134/134914.png'
                });
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        async function updateOnlineCount() {
            try {
                await supabase.from('online_users').upsert([
                    { username: username, last_seen: new Date().toISOString() }
                ], { onConflict: 'username' });

                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                const { data } = await supabase
                    .from('online_users')
                    .select('username')
                    .gte('last_seen', fiveMinutesAgo);

                onlineUsers = data ? data.length : 0;
            } catch (e) {
                console.log('Online count feature needs online_users table');
            }
        }

        function renderChangelog() {
            if (!showChangelog) return '';
            
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;" id="changelogModal">
                    <div style="background: white; margin: 50px auto; padding: 20px; max-width: 500px; border: 2px solid black;">
                        <h2>Changelog</h2>
                        ${CHANGELOG.map(log => `
                            <div style="margin-bottom: 15px;">
                                <strong>${log.version}</strong>
                                <ul>
                                    ${log.changes.map(change => `<li>${change}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                        <button id="closeChangelog" style="padding: 5px 15px;">Close</button>
                    </div>
                </div>
            `;
        }

        function renderMediaPicker() {
            if (!showMediaPicker) return '';
            
            if (showCamera) {
                return `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000;" id="cameraModal">
                        <div style="background: white; margin: 20px auto; padding: 20px; max-width: 600px; border: 2px solid black; text-align: center;">
                            <h2>Take a Photo</h2>
                            <video id="cameraPreview" autoplay style="width: 100%; max-width: 500px; border: 2px solid black;"></video>
                            <canvas id="photoCanvas" style="display: none;"></canvas>
                            <div style="margin-top: 10px;">
                                <button id="captureBtn" style="padding: 10px 20px; font-size: 16px; margin-right: 10px;">ðŸ“¸ Capture</button>
                                <button id="closeCameraBtn" style="padding: 10px 20px;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;" id="mediaPickerModal">
                    <div style="background: white; margin: 50px auto; padding: 20px; max-width: 500px; border: 2px solid black; max-height: 500px; overflow-y: auto;">
                        <h2>Choose Media</h2>
                        
                        <div style="margin-bottom: 20px;">
                            <h3>Take Photo</h3>
                            <button id="openCameraBtn" style="padding: 10px 20px; font-size: 16px;">ðŸ“· Open Camera</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3>Upload Image</h3>
                            <input type="file" id="imageUpload" accept="image/*" style="padding: 5px;">
                            <button id="uploadBtn" style="padding: 5px 15px; margin-left: 10px;">Upload</button>
                        </div>
                        
                        <div>
                            <h3>Choose GIF</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                ${GIFS.map((gif, index) => `
                                    <img src="${gif}" style="width: 100%; cursor: pointer; border: 2px solid black;" class="gif-option" data-gif="${gif}">
                                `).join('')}
                            </div>
                        </div>
                        
                        <button id="closeMediaPicker" style="padding: 5px 15px; margin-top: 20px;">Close</button>
                    </div>
                </div>
            `;
        }

        function render() {
            const appDiv = document.getElementById('app');
            
            if (!joined) {
                appDiv.innerHTML = `
                    <div style="padding: 20px; font-family: Arial;">
                        <div style="background: black; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center;">
                            <strong>Global Chatroom ${VERSION}</strong>
                            <button id="showChangelogBtn" style="margin-left: 10px; padding: 3px 8px; font-size: 12px;">What's New</button>
                        </div>
                        <h1>Global Chatroom</h1>
                        <p>Enter your username to join</p>
                        <input type="text" id="usernameInput" placeholder="Username" style="padding: 5px; margin-right: 10px;">
                        <button id="joinBtn" style="padding: 5px 15px;">Join</button>
                    </div>
                    ${renderChangelog()}
                `;
                
                const showBtn = document.getElementById('showChangelogBtn');
                if (showBtn) {
                    showBtn.onclick = () => {
                        showChangelog = true;
                        render();
                    };
                }

                const closeBtn = document.getElementById('closeChangelog');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        showChangelog = false;
                        render();
                    };
                }

                const modal = document.getElementById('changelogModal');
                if (modal) {
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            showChangelog = false;
                            render();
                        }
                    };
                }
                
                document.getElementById('joinBtn').onclick = async () => {
                    const input = document.getElementById('usernameInput');
                    if (input.value.trim()) {
                        username = input.value.trim();
                        joined = true;
                        await requestNotificationPermission();
                        render();
                        loadMessages();
                        updateOnlineCount();
                        setInterval(loadMessages, 2000);
                        setInterval(updateOnlineCount, 30000);
                    }
                };
                
                document.getElementById('usernameInput').onkeypress = (e) => {
                    if (e.key === 'Enter') document.getElementById('joinBtn').click();
                };
            } else {
                appDiv.innerHTML = `
                    <div style="padding: 20px; font-family: Arial;">
                        <div style="background: black; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center;">
                            <strong>Global Chatroom ${VERSION}</strong>
                            <button id="showChangelogBtn" style="margin-left: 10px; padding: 3px 8px; font-size: 12px;">What's New</button>
                            <span style="margin-left: 20px;">ðŸ‘¥ ${onlineUsers} online</span>
                        </div>
                        <h1>Global Chatroom</h1>
                        <p>Logged in as: ${username}</p>
                        <div style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" id="notifToggle" ${notificationsEnabled ? 'checked' : ''}>
                                Enable Notifications
                            </label>
                        </div>
                        ${replyingTo ? `
                            <div style="background: lightgray; padding: 5px; margin-bottom: 10px;">
                                Replying to <strong>${replyingTo.username}</strong>: ${replyingTo.text || '[Image]'}
                                <button id="cancelReply" style="margin-left: 10px; padding: 2px 8px;">Cancel</button>
                            </div>
                        ` : ''}
                        <div id="messages" style="border: 1px solid black; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 5px;">
                            <button id="mediaPlusBtn" style="padding: 5px 15px; font-size: 18px;">+</button>
                            <input type="text" id="messageInput" placeholder="Type message..." style="padding: 5px; flex: 1;">
                            <button id="voiceBtn" style="padding: 5px 15px; font-size: 18px; background: ${isRecording ? 'red' : 'white'};">ðŸŽ¤</button>
                            <button id="sendBtn" style="padding: 5px 15px;">Send</button>
                        </div>
                        ${isRecording ? '<div style="margin-top: 5px; color: red;">Recording... Hold button to continue</div>' : ''}
                    </div>
                    ${renderChangelog()}
                    ${renderMediaPicker()}
                `;

                const showBtn = document.getElementById('showChangelogBtn');
                if (showBtn) {
                    showBtn.onclick = () => {
                        showChangelog = true;
                        render();
                    };
                }

                const closeBtn = document.getElementById('closeChangelog');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        showChangelog = false;
                        render();
                    };
                }

                const modal = document.getElementById('changelogModal');
                if (modal) {
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            showChangelog = false;
                            render();
                        }
                    };
                }

                const cancelBtn = document.getElementById('cancelReply');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        replyingTo = null;
                        render();
                    };
                }

                const mediaPlusBtn = document.getElementById('mediaPlusBtn');
                if (mediaPlusBtn) {
                    mediaPlusBtn.onclick = () => {
                        showMediaPicker = true;
                        render();
                    };
                }

                const closeMediaBtn = document.getElementById('closeMediaPicker');
                if (closeMediaBtn) {
                    closeMediaBtn.onclick = () => {
                        showMediaPicker = false;
                        render();
                    };
                }

                const mediaModal = document.getElementById('mediaPickerModal');
                if (mediaModal) {
                    mediaModal.onclick = (e) => {
                        if (e.target === mediaModal) {
                            showMediaPicker = false;
                            render();
                        }
                    };
                }

                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.onclick = handleImageUpload;
                }

                const openCameraBtn = document.getElementById('openCameraBtn');
                if (openCameraBtn) {
                    openCameraBtn.onclick = openCamera;
                }

                const captureBtn = document.getElementById('captureBtn');
                if (captureBtn) {
                    captureBtn.onclick = capturePhoto;
                }

                const closeCameraBtn = document.getElementById('closeCameraBtn');
                if (closeCameraBtn) {
                    closeCameraBtn.onclick = closeCamera;
                }

                const gifOptions = document.querySelectorAll('.gif-option');
                gifOptions.forEach(gif => {
                    gif.onclick = () => {
                        sendGif(gif.dataset.gif);
                    };
                });

                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.onmousedown = startRecording;
                    voiceBtn.onmouseup = stopRecording;
                    voiceBtn.onmouseleave = stopRecording;
                    voiceBtn.ontouchstart = (e) => {
                        e.preventDefault();
                        startRecording();
                    };
                    voiceBtn.ontouchend = (e) => {
                        e.preventDefault();
                        stopRecording();
                    };
                }
                
                document.getElementById('notifToggle').onchange = async (e) => {
                    notificationsEnabled = e.target.checked;
                    if (notificationsEnabled && Notification.permission === 'default') {
                        await requestNotificationPermission();
                    }
                };
                
                document.getElementById('sendBtn').onclick = sendMessage;
                document.getElementById('messageInput').onkeypress = (e) => {
                    if (e.key === 'Enter') sendMessage();
                };
            }
        }

        async function handleImageUpload() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an image first!');
                return;
            }

            if (file.size > 5000000) {
                alert('Image too large! Please choose an image under 5MB.');
                return;
            }

            const fileName = `${Date.now()}_${file.name}`;
            
            try {
                const { data, error } = await supabase.storage
                    .from('chat-images')
                    .upload(fileName, file);

                if (error) throw error;

                const { data: publicURL } = supabase.storage
                    .from('chat-images')
                    .getPublicUrl(fileName);

                await sendImage(publicURL.publicUrl);
                showMediaPicker = false;
                render();
            } catch (error) {
                alert('Error uploading image: ' + error.message);
            }
        }

        async function sendGif(gifUrl) {
            await sendImage(gifUrl);
            showMediaPicker = false;
            render();
        }

        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                showCamera = true;
                render();
                
                setTimeout(() => {
                    const video = document.getElementById('cameraPreview');
                    if (video) {
                        video.srcObject = cameraStream;
                    }
                }, 100);
            } catch (error) {
                alert('Error accessing camera: ' + error.message);
            }
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            showCamera = false;
            render();
        }

        async function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const fileName = `${Date.now()}_photo.jpg`;
                
                try {
                    const { data, error } = await supabase.storage
                        .from('chat-images')
                        .upload(fileName, blob);

                    if (error) throw error;

                    const { data: publicURL } = supabase.storage
                        .from('chat-images')
                        .getPublicUrl(fileName);

                    await sendImage(publicURL.publicUrl);
                    closeCamera();
                    showMediaPicker = false;
                    render();
                } catch (error) {
                    alert('Error uploading photo: ' + error.message);
                }
            }, 'image/jpeg');
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                render();
            } catch (error) {
                alert('Error accessing microphone: ' + error.message);
            }
        }

        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                render();
            }
        }

        async function uploadVoiceMessage(audioBlob) {
            const fileName = `${Date.now()}_voice.webm`;
            
            try {
                const { data, error } = await supabase.storage
                    .from('voice-messages')
                    .upload(fileName, audioBlob);

                if (error) throw error;

                const { data: publicURL } = supabase.storage
                    .from('voice-messages')
                    .getPublicUrl(fileName);

                await sendVoice(publicURL.publicUrl);
            } catch (error) {
                alert('Error uploading voice message: ' + error.message);
            }
        }

        async function sendVoice(voiceUrl) {
            const messageData = {
                username: username,
                text: '',
                voice_url: voiceUrl
            };
            
            if (replyingTo) {
                messageData.reply_to = JSON.stringify({
                    username: replyingTo.username,
                    text: replyingTo.text
                });
            }
            
            await supabase.from('messages').insert([messageData]);
            replyingTo = null;
            render();
        }

        async function sendImage(imageUrl) {
            const messageData = {
                username: username,
                text: '',
                image_url: imageUrl
            };
            
            if (replyingTo) {
                messageData.reply_to = JSON.stringify({
                    username: replyingTo.username,
                    text: replyingTo.text
                });
            }
            
            await supabase.from('messages').insert([messageData]);
            replyingTo = null;
            render();
        }

        async function loadMessages() {
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(50);

            if (data) {
                const messagesDiv = document.getElementById('messages');
                if (messagesDiv) {
                    const wasAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop === messagesDiv.clientHeight;
                    
                    if (data.length > lastMessageCount && lastMessageCount > 0) {
                        const newMessage = data[data.length - 1];
                        if (newMessage.username !== username) {
                            showNotification(newMessage.username, newMessage.text);
                        }
                    }
                    lastMessageCount = data.length;
                    
                    messagesDiv.innerHTML = '';
                    data.forEach((msg, index) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.style.marginBottom = '10px';
                        msgDiv.style.padding = '5px';
                        msgDiv.style.cursor = 'pointer';
                        msgDiv.style.borderLeft = msg.reply_to ? '3px solid gray' : 'none';
                        msgDiv.style.paddingLeft = msg.reply_to ? '10px' : '5px';
                        
                        let html = '';
                        if (msg.reply_to) {
                            try {
                                const replyData = JSON.parse(msg.reply_to);
                                html += `<div style="font-size: 12px; color: gray; margin-bottom: 3px;">â†© Replying to ${replyData.username}</div>`;
                            } catch (e) {}
                        }
                        
                        html += `<strong>${msg.username}</strong> <span style="font-size: 11px; color: gray;">${formatTime(msg.created_at)}</span><br>`;
                        
                        if (msg.image_url) {
                            html += `<img src="${msg.image_url}" style="max-width: 300px; max-height: 300px; margin-top: 5px; border: 1px solid black;">`;
                        }
                        
                        if (msg.voice_url) {
                            html += `<div style="margin-top: 5px;"><audio controls style="max-width: 300px;"><source src="${msg.voice_url}" type="audio/webm"></audio></div>`;
                        }
                        
                        if (msg.text) {
                            html += msg.text;
                        }
                        
                        msgDiv.innerHTML = html;
                        
                        msgDiv.onclick = () => {
                            replyingTo = { username: msg.username, text: msg.text, id: msg.id };
                            render();
                            document.getElementById('messageInput').focus();
                        };
                        
                        messagesDiv.appendChild(msgDiv);
                    });
                    
                    if (wasAtBottom || lastMessageCount === data.length) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input.value.trim()) {
                const messageData = {
                    username: username,
                    text: input.value.trim()
                };
                
                if (replyingTo) {
                    messageData.reply_to = JSON.stringify({
                        username: replyingTo.username,
                        text: replyingTo.text
                    });
                }
                
                await supabase.from('messages').insert([messageData]);
                input.value = '';
                replyingTo = null;
                render();
            }
        }

        render();
    </script>
</body>
</html>
